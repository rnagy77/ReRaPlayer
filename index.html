import React, { useEffect, useRef, useState } from "react";

// React single-file component -> Default export
// TailwindCSS classnames are used for styling. To preview this component
// create a Vite or CRA app, enable Tailwind, and drop this component into App.jsx.

const DEFAULT_RADIOS = [
  {
    id: 1,
    name: "Radio4U",
    url: "http://mpc1.mediacp.eu:8342/stream",
    bitrate: "128 kbps",
    description: "Local hits & mixes",
  },
  {
    id: 2,
    name: "Radio Groove",
    url: "http://radiogroove.hu:80/live.mp3",
    bitrate: "128 kbps",
    description: "Groovy tunes",
  },
  {
    id: 3,
    name: "Dance Wave Retro",
    url: "http://dancewave.online:8080/retrodance.mp3",
    bitrate: "~135 kbps",
    description: "Retro dance classics",
  },
  {
    id: 4,
    name: "MegaDance Radio",
    url: "https://gamershouse.hu:8080/livemega.mp3",
    bitrate: "192 kbps",
    description: "Big dance anthems",
  },
  {
    id: 5,
    name: "Radio 538",
    url: "https://playerservices.streamtheworld.com/api/livestream-redirect/RADIO538AAC_SC",
    bitrate: "256 kbps",
    description: "International hits",
  },
];

function useLocalStorage(key, initial) {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    } catch (e) {
      return initial;
    }
  });

  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch (e) {}
  }, [key, state]);

  return [state, setState];
}

export default function RadioPlayerApp() {
  const [radios, setRadios] = useLocalStorage("radios_v1", DEFAULT_RADIOS);
  const [currentIndex, setCurrentIndex] = useLocalStorage("radio_index_v1", 0);
  const [isPlaying, setIsPlaying] = useLocalStorage("radio_playing_v1", false);
  const [favorites, setFavorites] = useLocalStorage("radio_favs_v1", []);
  const [query, setQuery] = useState("");
  const [showEdit, setShowEdit] = useState(false);
  const [editItem, setEditItem] = useState(null);
  const audioRef = useRef(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Keep index in bounds
  useEffect(() => {
    if (radios.length === 0) {
      setCurrentIndex(0);
      setIsPlaying(false);
    } else if (currentIndex >= radios.length) {
      setCurrentIndex(0);
    }
  }, [radios, currentIndex, setCurrentIndex]);

  // play/pause effect
  useEffect(() => {
    const audio = audioRef.current;
    if (!audio) return;
    if (isPlaying) {
      setLoading(true);
      setError(null);
      // try to play => browsers require user gesture in some cases
      const playPromise = audio.play();
      if (playPromise && playPromise.then) {
        playPromise
          .then(() => setLoading(false))
          .catch((e) => {
            setLoading(false);
            setIsPlaying(false);
            setError("A b√∂ng√©sz≈ë blokkolta az automatikus lej√°tsz√°st ‚Äî nyomd meg a play gombot");
          });
      } else {
        setLoading(false);
      }
    } else {
      audio.pause();
    }
  }, [isPlaying, currentIndex]);

  // if stream changes, reload audio src
  useEffect(() => {
    const audio = audioRef.current;
    if (!audio) return;
    audio.src = radios[currentIndex] ? radios[currentIndex].url : "";
    audio.load();
  }, [currentIndex, radios]);

  function prev() {
    setCurrentIndex((i) => (radios.length === 0 ? 0 : (i - 1 + radios.length) % radios.length));
    setIsPlaying(true);
  }
  function next() {
    setCurrentIndex((i) => (radios.length === 0 ? 0 : (i + 1) % radios.length));
    setIsPlaying(true);
  }

  function togglePlay() {
    setIsPlaying((p) => !p);
  }

  function toggleFav(id) {
    setFavorites((favs) => {
      if (favs.includes(id)) return favs.filter((x) => x !== id);
      return [...favs, id];
    });
  }

  function openEdit(item = null) {
    setEditItem(item);
    setShowEdit(true);
  }

  function saveEdit(form) {
    if (!form.name || !form.url) return;
    setRadios((list) => {
      if (form.id) {
        return list.map((r) => (r.id === form.id ? { ...r, ...form } : r));
      }
      const newItem = { ...form, id: Date.now() };
      return [...list, newItem];
    });
    setShowEdit(false);
  }

  function removeRadio(id) {
    if (!confirm("Biztosan t√∂rl√∂d a csatorn√°t?")) return;
    setRadios((list) => list.filter((r) => r.id !== id));
  }

  function importJSON(text) {
    try {
      const parsed = JSON.parse(text);
      if (Array.isArray(parsed)) {
        setRadios(parsed.map((r, idx) => ({ id: r.id || Date.now() + idx, ...r })));
        alert("Import√°lva");
      } else alert("A JSON nem t√∂mb");
    } catch (e) {
      alert("Hib√°s JSON: " + e.message);
    }
  }

  const filtered = radios.filter((r) => r.name.toLowerCase().includes(query.toLowerCase()) || (r.description || "").toLowerCase().includes(query.toLowerCase()));

  // small helper: show radio metadata (bitrate + description)
  const current = radios[currentIndex] || null;

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-100 to-gray-200 p-4">
      <div className="max-w-3xl mx-auto">
        <header className="bg-indigo-700 text-white rounded-xl p-4 shadow-md mb-4">
          <div className="flex items-center justify-between">
            <h1 className="text-lg font-semibold">üéß Kedvenc R√°di√≥im</h1>
            <div className="text-sm">GitHub Pages kompatibilis React sablon</div>
          </div>
        </header>

        <main className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {/* Left: controls */}
          <section className="md:col-span-1 bg-white rounded-xl p-4 shadow">
            <div className="mb-3">
              <div className="text-sm text-gray-500">Most j√°tszik</div>
              <div className="font-medium text-indigo-700 text-lg">{current ? current.name : "(nincs csatorna)"}</div>
              <div className="text-sm text-gray-600">{current ? current.description : ""}</div>
            </div>

            <div className="flex items-center space-x-2 mb-3">
              <button onClick={prev} className="px-3 py-2 bg-gray-100 rounded">‚óÄ</button>
              <button onClick={togglePlay} className="px-4 py-2 rounded bg-indigo-600 text-white">
                {isPlaying ? "Pause" : "Play"}
              </button>
              <button onClick={next} className="px-3 py-2 bg-gray-100 rounded">‚ñ∂</button>
            </div>

            <div className="text-sm text-gray-600 mb-3">Bitr√°ta: <span className="font-medium">{current ? current.bitrate || "‚Äì" : "‚Äì"}</span></div>

            <div className="mb-3">
              <label className="block text-sm text-gray-500">Keres√©s</label>
              <input value={query} onChange={(e) => setQuery(e.target.value)} className="w-full mt-1 p-2 border rounded" placeholder="Csatorna neve vagy le√≠r√°s" />
            </div>

            <div className="flex flex-col space-y-2">
              <button onClick={() => openEdit(null)} className="w-full py-2 rounded bg-green-500 text-white">√öj csatorna</button>
              <button onClick={() => {
                const exported = JSON.stringify(radios, null, 2);
                navigator.clipboard?.writeText(exported);
                alert("Radio lista kim√°solva a v√°g√≥lapra (JSON)");
              }} className="w-full py-2 rounded bg-gray-100">Export JSON</button>
              <button onClick={() => {
                const txt = prompt("Illeszd be a JSON-t az import√°l√°shoz:");
                if (txt) importJSON(txt);
              }} className="w-full py-2 rounded bg-gray-100">Import JSON</button>
            </div>

            <div className="mt-3 text-xs text-gray-500">Megjegyz√©s: a bitr√°ta jelenleg a lista mez≈ëj√©b≈ël sz√°rmazik. Ha szeretn√©l val√≥s id≈ëben lek√©rni meta adatokat, sz√ºks√©g van proxy/backend szolg√°ltat√°sra (GitHub Pages statikus), pl. egy kis Cloud Function-re.</div>
          </section>

          {/* Right: list */}
          <section className="md:col-span-2 bg-white rounded-xl p-4 shadow">
            <div className="grid gap-3">
              {filtered.map((r, idx) => (
                <article key={r.id} className="flex items-center justify-between p-3 border rounded">
                  <div className="flex items-center space-x-3">
                    <div className="w-12 h-12 bg-indigo-50 rounded flex items-center justify-center text-indigo-600 font-semibold">{r.name.split(" ").slice(0,2).map(s=>s[0]).join("")}</div>
                    <div>
                      <div className="font-medium">{r.name}</div>
                      <div className="text-sm text-gray-500">{r.description} ‚Ä¢ {r.bitrate || "‚Äì"}</div>
                      <div className="text-xs text-gray-400">{r.url}</div>
                    </div>
                  </div>

                  <div className="flex items-center space-x-2">
                    <button onClick={() => { setCurrentIndex(radios.findIndex(x=>x.id===r.id)); setIsPlaying(true); }} className="px-3 py-2 bg-indigo-600 text-white rounded">Play</button>
                    <button onClick={() => toggleFav(r.id)} className={`px-2 py-2 rounded ${favorites.includes(r.id) ? 'bg-yellow-400' : 'bg-gray-100'}`}>{favorites.includes(r.id) ? '‚òÖ' : '‚òÜ'}</button>
                    <button onClick={() => openEdit(r)} className="px-2 py-2 bg-gray-100 rounded">Edit</button>
                    <button onClick={() => removeRadio(r.id)} className="px-2 py-2 bg-red-100 text-red-600 rounded">Del</button>
                  </div>
                </article>
              ))}

              {filtered.length === 0 && <div className="text-center text-gray-500 p-6">Nincs tal√°lat.</div>}
            </div>
          </section>
        </main>

        <audio ref={audioRef} style={{ display: "none" }} preload="none" controls />

        {/* Edit modal (simple) */}
        {showEdit && (
          <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl p-4 w-full max-w-md shadow-lg">
              <h3 className="font-semibold mb-2">{editItem ? 'Csatorna szerkeszt√©se' : '√öj csatorna'}</h3>
              <RadioEditForm initial={editItem} onCancel={() => setShowEdit(false)} onSave={(f) => saveEdit(f)} />
            </div>
          </div>
        )}

        <footer className="mt-6 text-center text-sm text-gray-500">¬© 2025 ‚Äî React r√°di√≥lej√°tsz√≥ sablon ‚Ä¢ GitHub Pages kompatibilis</footer>

      </div>
    </div>
  );
}

function RadioEditForm({ initial, onCancel, onSave }) {
  const [form, setForm] = useState(() => initial ? { ...initial } : { name: "", url: "", bitrate: "", description: "" });
  return (
    <form onSubmit={(e) => { e.preventDefault(); onSave(form); }}>
      <div className="mb-2">
        <label className="block text-sm text-gray-600">N√©v</label>
        <input value={form.name} onChange={(e)=>setForm({...form, name: e.target.value})} className="w-full p-2 border rounded" />
      </div>
      <div className="mb-2">
        <label className="block text-sm text-gray-600">Stream URL</label>
        <input value={form.url} onChange={(e)=>setForm({...form, url: e.target.value})} className="w-full p-2 border rounded" />
      </div>
      <div className="mb-2">
        <label className="block text-sm text-gray-600">Bitr√°ta (pl. 128 kbps)</label>
        <input value={form.bitrate} onChange={(e)=>setForm({...form, bitrate: e.target.value})} className="w-full p-2 border rounded" />
      </div>
      <div className="mb-3">
        <label className="block text-sm text-gray-600">Le√≠r√°s</label>
        <input value={form.description} onChange={(e)=>setForm({...form, description: e.target.value})} className="w-full p-2 border rounded" />
      </div>
      <div className="flex justify-end space-x-2">
        <button type="button" onClick={onCancel} className="px-3 py-2 rounded bg-gray-100">M√©gse</button>
        <button type="submit" className="px-3 py-2 rounded bg-indigo-600 text-white">Ment√©s</button>
      </div>
    </form>
  );
}
